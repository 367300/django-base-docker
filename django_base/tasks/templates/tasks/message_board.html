{% block content %}
<h2>Чат сообщений</h2>
<div id="messages">
    {% for msg in messages %}
    <div class="message" id="msg-{{ msg.id }}">
        <div class="category" id="cat-{{ msg.id }}">{{ msg.category|default:'Ожидание' }}</div>
        <div class="text">{{ msg.text }}</div>
        <div class="date">{{ msg.created|date:'d.m.Y H:i:s' }}</div>
    </div>
    {% endfor %}
</div>
<form id="msg-form">
    <input type="text" id="msg-text" name="text" placeholder="Введите сообщение..." required>
    <button type="submit">Отправить</button>
</form>
<script>
function addMessage(msg) {
    const div = document.createElement('div');
    div.className = 'message';
    div.id = 'msg-' + msg.id;
    div.innerHTML = `<div class="category" id="cat-${msg.id}">${msg.category || 'Ожидание'}</div>
        <div class="text">${msg.text}</div>
        <div class="date">${msg.created ? msg.created : ''}</div>`;
    document.getElementById('messages').prepend(div);
    subscribeCategory(msg.id);
}

document.getElementById('msg-form').onsubmit = function(e) {
    e.preventDefault();
    const text = document.getElementById('msg-text').value;
    fetch('{% url 'tasks:send_message' %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'text=' + encodeURIComponent(text)
    })
    .then(r => r.json())
    .then(data => {
        if (data.id) {
            addMessage(data);
            document.getElementById('msg-text').value = '';
        } else {
            alert(data.error || 'Ошибка');
        }
    });
};

function subscribeCategory(msgId) {
    const ws = new WebSocket(`ws://${window.location.host}/ws/tasks/message/${msgId}/`);
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.category) {
            document.getElementById('cat-' + msgId).textContent = data.category;
        }
    };
}
// Подписываемся на все существующие сообщения
{% for msg in messages %}
subscribeCategory("{{ msg.id }}");
{% endfor %}
</script>
{% endblock %} 